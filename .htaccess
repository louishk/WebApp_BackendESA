# ─────────────────────────────────────────────────────────────
# WebApp Backend - Apache Configuration
# ─────────────────────────────────────────────────────────────

# Extend PHP session lifetime to 4 hours
<IfModule mod_php7.c>
    php_value session.gc_maxlifetime 14400
    php_value session.cookie_lifetime 14400
</IfModule>
<IfModule mod_php.c>
    php_value session.gc_maxlifetime 14400
    php_value session.cookie_lifetime 14400
</IfModule>

RewriteEngine On

# ─────────────────────────────────────────────────────────────
# 1) Security - Block sensitive files
# ─────────────────────────────────────────────────────────────
<FilesMatch "^\.env$">
    Order deny,allow
    Deny from all
</FilesMatch>

<FilesMatch "\.(sql|log|md)$">
    Order deny,allow
    Deny from all
</FilesMatch>

# Block access to sql directory
RewriteRule ^sql/ - [F,L]

# ─────────────────────────────────────────────────────────────
# 2) Serve existing files and directories directly
# ─────────────────────────────────────────────────────────────
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# ─────────────────────────────────────────────────────────────
# 3) Static assets - serve directly
# ─────────────────────────────────────────────────────────────
RewriteRule \.(js|css|png|jpe?g|gif|ico|svg|woff2?|ttf|eot)$ - [L,NC]

# ─────────────────────────────────────────────────────────────
# 4) Exempt specific directories from slug routing
# ─────────────────────────────────────────────────────────────
# Admin folder
RewriteRule ^admin/ - [L]

# App folder (scheduler, future apps)
RewriteRule ^app/ - [L]

# Pages folder (direct access)
RewriteRule ^pages/ - [L]

# Vendor folder
RewriteRule ^vendor/ - [L]

# ─────────────────────────────────────────────────────────────
# 5) Exempt specific public scripts
# ─────────────────────────────────────────────────────────────
RewriteRule ^(login|login_microsoft|oauth_callback|logout|dashboard)\.php$ - [L]

# ─────────────────────────────────────────────────────────────
# 6) Catch-all slugs → index.php (for dynamic pages)
# ─────────────────────────────────────────────────────────────
RewriteRule ^([a-z0-9\-/]+)/?$ index.php?page=$1 [L,QSA]
