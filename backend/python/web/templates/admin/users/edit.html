{% extends "base.html" %}

{% block title %}{{ 'Edit User' if user else 'Create User' }} - ESA Backend{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ 'Edit User: ' + user.username if user else 'Create New User' }}</h1>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div style="margin-bottom: 1rem;">
            {% for category, message in messages %}
                <div class="flash flash-{{ category }}" style="padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 0.5rem;
                    {% if category == 'error' %}background: #fee2e2; color: #dc2626; border: 1px solid #fecaca;{% endif %}
                    {% if category == 'success' %}background: #d1fae5; color: #059669; border: 1px solid #a7f3d0;{% endif %}
                ">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="card">
    <form method="POST">
        {% if not user %}
        <div style="margin-bottom: 1.25rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Username *</label>
            <input type="text" name="username" required
                   style="width: 100%; max-width: 400px; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 1rem;">
        </div>
        {% endif %}

        <div style="margin-bottom: 1.25rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
            <input type="email" name="email" value="{{ user.email if user else '' }}"
                   style="width: 100%; max-width: 400px; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 1rem;">
        </div>

        <div style="margin-bottom: 1.25rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                Password {% if user %}(leave blank to keep current){% else %}*{% endif %}
            </label>
            <input type="password" name="password" {% if not user %}required{% endif %}
                   style="width: 100%; max-width: 400px; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 1rem;">
        </div>

        <div style="margin-bottom: 1.25rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Role *</label>
            <select name="role_id" required
                    style="width: 100%; max-width: 400px; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 1rem;">
                <option value="">-- Select a role --</option>
                {% for role in roles %}
                <option value="{{ role.id }}" {% if user and user.role_id == role.id %}selected{% endif %}>
                    {{ role.name }} - {{ role.description or 'No description' }}
                </option>
                {% endfor %}
            </select>
            <p style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">
                Role determines what permissions the user has in the system.
                <a href="{{ url_for('admin.list_roles') }}" style="color: var(--esa-red);">Manage roles</a>
            </p>
        </div>

        <div style="margin-top: 2rem;">
            <button type="submit" class="btn">{{ 'Update User' if user else 'Create User' }}</button>
            <a href="{{ url_for('admin.list_users') }}" class="btn btn-secondary" style="margin-left: 0.5rem;">Cancel</a>
        </div>
    </form>
</div>

{% if user and user.role %}
<div class="card" style="margin-top: 1.5rem;">
    <h2>Current Role Permissions</h2>
    <table>
        <thead>
            <tr>
                <th>Permission</th>
                <th>Granted</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Scheduler Access</td>
                <td>
                    {% if user.role.can_access_scheduler %}
                        <span class="status status-completed">Yes</span>
                    {% else %}
                        <span class="status status-pending">No</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>User Management</td>
                <td>
                    {% if user.role.can_manage_users %}
                        <span class="status status-completed">Yes</span>
                    {% else %}
                        <span class="status status-pending">No</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>Page Management</td>
                <td>
                    {% if user.role.can_manage_pages %}
                        <span class="status status-completed">Yes</span>
                    {% else %}
                        <span class="status status-pending">No</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>Role Management</td>
                <td>
                    {% if user.role.can_manage_roles %}
                        <span class="status status-completed">Yes</span>
                    {% else %}
                        <span class="status status-pending">No</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>Config Management</td>
                <td>
                    {% if user.role.can_manage_configs %}
                        <span class="status status-completed">Yes</span>
                    {% else %}
                        <span class="status status-pending">No</span>
                    {% endif %}
                </td>
            </tr>
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}
