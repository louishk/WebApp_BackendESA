{% extends "base.html" %}

{% block title %}Jobs - ESA Backend{% endblock %}

{% block content %}
<div class="card">
    <h2>Scheduled Pipelines</h2>
    <table id="jobs-table-main">
        <thead>
            <tr>
                <th class="sortable" data-sort="display_name">Pipeline <span class="sort-icon"></span></th>
                <th class="sortable" data-sort="schedule">Schedule <span class="sort-icon"></span></th>
                <th class="sortable" data-sort="priority">Priority <span class="sort-icon"></span></th>
                <th class="sortable" data-sort="resource_group">Resource <span class="sort-icon"></span></th>
                <th class="sortable" data-sort="latest_data">Latest Data <span class="sort-icon"></span></th>
                <th class="sortable" data-sort="enabled">Status <span class="sort-icon"></span></th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="jobs-table">
            <tr><td colspan="7" style="text-align: center; color: #666;">Loading...</td></tr>
        </tbody>
    </table>
</div>

<!-- Edit Schedule Modal -->
<div id="editModal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3>Edit Schedule: <span id="editPipelineName"></span></h3>
        <form id="editForm">
            <input type="hidden" id="editPipelineId">
            <input type="hidden" id="cronInput">

            <div class="form-group">
                <label>Frequency:</label>
                <select id="scheduleFrequency" onchange="onFrequencyChange()">
                    <option value="minutes">Every X Minutes</option>
                    <option value="hourly">Every Hour</option>
                    <option value="hours">Every X Hours</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
            </div>

            <div class="form-group" id="minutesIntervalGroup" style="display:none;">
                <label>Run Every:</label>
                <select id="scheduleMinutesInterval">
                    <option value="5">5 minutes</option>
                    <option value="10">10 minutes</option>
                    <option value="15">15 minutes</option>
                    <option value="20">20 minutes</option>
                    <option value="30">30 minutes</option>
                </select>
            </div>

            <div class="form-group" id="hoursIntervalGroup" style="display:none;">
                <label>Run Every:</label>
                <select id="scheduleHoursInterval">
                    <option value="2">2 hours</option>
                    <option value="3">3 hours</option>
                    <option value="4">4 hours</option>
                    <option value="6">6 hours</option>
                    <option value="8">8 hours</option>
                    <option value="12">12 hours</option>
                </select>
            </div>

            <div class="form-group" id="dayOfWeekGroup" style="display:none;">
                <label>Day of Week:</label>
                <select id="scheduleDayOfWeek">
                    <option value="0">Sunday</option>
                    <option value="1">Monday</option>
                    <option value="2">Tuesday</option>
                    <option value="3">Wednesday</option>
                    <option value="4">Thursday</option>
                    <option value="5">Friday</option>
                    <option value="6">Saturday</option>
                </select>
            </div>

            <div class="form-group" id="dayOfMonthGroup" style="display:none;">
                <label>Day of Month:</label>
                <select id="scheduleDayOfMonth">
                    <option value="1">1st</option>
                    <option value="2">2nd</option>
                    <option value="3">3rd</option>
                    <option value="4">4th</option>
                    <option value="5">5th</option>
                    <option value="6">6th</option>
                    <option value="7">7th</option>
                    <option value="8">8th</option>
                    <option value="9">9th</option>
                    <option value="10">10th</option>
                    <option value="11">11th</option>
                    <option value="12">12th</option>
                    <option value="13">13th</option>
                    <option value="14">14th</option>
                    <option value="15">15th</option>
                    <option value="16">16th</option>
                    <option value="17">17th</option>
                    <option value="18">18th</option>
                    <option value="19">19th</option>
                    <option value="20">20th</option>
                    <option value="21">21st</option>
                    <option value="22">22nd</option>
                    <option value="23">23rd</option>
                    <option value="24">24th</option>
                    <option value="25">25th</option>
                    <option value="26">26th</option>
                    <option value="27">27th</option>
                    <option value="28">28th</option>
                </select>
            </div>

            <div class="form-group" id="timeGroup">
                <label>Time:</label>
                <div style="display:flex;gap:8px;align-items:center;">
                    <select id="scheduleHour" style="width:70px;">
                        <option value="12">12</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                    </select>
                    <span>:</span>
                    <select id="scheduleMinute" style="width:70px;">
                        <option value="0">00</option>
                        <option value="15">15</option>
                        <option value="30">30</option>
                        <option value="45">45</option>
                    </select>
                    <select id="scheduleAmPm" style="width:70px;">
                        <option value="AM">AM</option>
                        <option value="PM">PM</option>
                    </select>
                </div>
            </div>

            <div class="form-group" style="background:#f5f5f5;padding:10px;border-radius:4px;margin-top:15px;">
                <small style="color:#666;">Schedule: <span id="schedulePreview" style="color:#1A2E5A;font-weight:500;">Daily at 6:00 AM</span></small>
            </div>

            <div class="form-group">
                <label>Priority (1=highest, 10=lowest):</label>
                <input type="number" id="priorityInput" min="1" max="10" value="5" style="width:80px;padding:8px;">
                <small style="color:#666;">Lower = runs first when multiple jobs queued</small>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="enabledCheck"> Enabled
                </label>
            </div>

            <div class="form-actions" style="margin-top:20px;">
                <button type="submit" class="btn">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Progress Modal -->
<div id="progressModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:700px;width:90%;">
        <h3>Running: <span id="progressPipelineName"></span></h3>
        <div style="margin-bottom:10px;">
            <span id="progressStatus" class="status status-running">Starting...</span>
            <span id="progressElapsed" style="margin-left:15px;color:#666;"></span>
        </div>
        <div id="progressOutput" style="background:#1A2E5A;color:#fff;border:1px solid #0F1B36;border-radius:4px;padding:10px;height:350px;overflow-y:auto;font-family:monospace;font-size:12px;white-space:pre-wrap;"></div>
        <div style="margin-top:15px;text-align:right;">
            <button class="btn btn-secondary" onclick="closeProgressModal()">Close</button>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(26, 46, 90, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
.modal-content {
    background: #fff;
    padding: 30px;
    border-radius: 8px;
    min-width: 400px;
    max-width: 500px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}
.modal-content h3 {
    color: #1A2E5A;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #C41230;
}
.form-group {
    margin-bottom: 15px;
}
.form-group label {
    display: block;
    margin-bottom: 5px;
    color: #333;
    font-weight: 500;
}
.form-group select, .form-group input[type="text"], .form-group input[type="number"] {
    background: #fff;
    border: 1px solid #ddd;
    color: #333;
    border-radius: 4px;
    padding: 8px;
}
.form-group select:focus, .form-group input:focus {
    border-color: #C41230;
    outline: none;
}
.form-group small {
    color: #666 !important;
}

/* Sortable table headers */
th.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 20px;
}
th.sortable:hover {
    background: rgba(196, 18, 48, 0.1);
}
th.sortable .sort-icon::after {
    content: '⇅';
    position: absolute;
    right: 6px;
    opacity: 0.3;
    font-size: 12px;
}
th.sortable.asc .sort-icon::after {
    content: '↑';
    opacity: 1;
    color: #C41230;
}
th.sortable.desc .sort-icon::after {
    content: '↓';
    opacity: 1;
    color: #C41230;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    const DAYS_OF_WEEK = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    // Singapore timezone formatting
    const SGT_OPTIONS = { timeZone: 'Asia/Singapore' };

    function formatDateSGT(dateStr) {
        if (!dateStr) return null;
        return new Date(dateStr).toLocaleDateString('en-SG', { ...SGT_OPTIONS, day: '2-digit', month: 'short', year: 'numeric' });
    }

    // Store jobs data for sorting
    let jobsData = [];
    let currentSort = { column: 'priority', direction: 'asc' };

    // Sort and render jobs
    function sortJobs(column) {
        // Toggle direction if same column
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }

        // Update header styles
        document.querySelectorAll('th.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
            if (th.dataset.sort === column) {
                th.classList.add(currentSort.direction);
            }
        });

        // Sort data
        jobsData.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];

            // Handle special cases
            if (column === 'enabled') {
                valA = valA ? 1 : 0;
                valB = valB ? 1 : 0;
            } else if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }

            if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });

        renderJobs();
    }

    function formatLatestDate(dateStr) {
        if (!dateStr) return '<span style="color:#999">-</span>';
        const date = new Date(dateStr);
        // Calculate diff using Singapore timezone for accurate "days ago"
        const nowSGT = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Singapore' }));
        const dateSGT = new Date(date.toLocaleString('en-US', { timeZone: 'Asia/Singapore' }));
        const diffDays = Math.floor((nowSGT - dateSGT) / (1000 * 60 * 60 * 24));

        let color = '#28a745';  // Green for fresh
        if (diffDays > 7) color = '#ffc107';  // Yellow for older than a week
        if (diffDays > 30) color = '#dc3545';  // Red for older than a month

        const formatted = date.toLocaleDateString('en-SG', { ...SGT_OPTIONS, day: '2-digit', month: 'short', year: 'numeric' });
        const ago = diffDays === 0 ? 'today' : diffDays === 1 ? '1 day ago' : `${diffDays} days ago`;

        return `<span style="color:${color}">${formatted}</span><br><small style="color:#888">${ago}</small>`;
    }

    function renderJobs() {
        const tbody = document.getElementById('jobs-table');
        if (!jobsData || jobsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No pipelines configured</td></tr>';
            return;
        }

        tbody.innerHTML = jobsData.map(job => {
            const enabled = job.enabled ? '<span class="status status-completed">Enabled</span>' : '<span class="status status-pending">Disabled</span>';
            const latestData = formatLatestDate(job.latest_data);
            return `
                <tr>
                    <td><strong>${job.display_name}</strong><br><small style="color:#666">${job.pipeline_name}</small></td>
                    <td title="${job.schedule}">${job.schedule_human}<br><small style="color:#888">${job.schedule}</small></td>
                    <td>${job.priority}</td>
                    <td>${job.resource_group}</td>
                    <td>${latestData}</td>
                    <td>${enabled}</td>
                    <td>
                        <button class="btn btn-sm" onclick="openEditModal('${job.pipeline_name}', '${job.schedule}', ${job.enabled}, ${job.priority})">Edit</button>
                        <button class="btn btn-sm" onclick="runPipeline('${job.pipeline_name}')">Run</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Add click handlers to sortable headers
    document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => sortJobs(th.dataset.sort));
    });

    // Show/hide day selectors based on frequency
    function onFrequencyChange() {
        const freq = document.getElementById('scheduleFrequency').value;
        document.getElementById('minutesIntervalGroup').style.display = freq === 'minutes' ? 'block' : 'none';
        document.getElementById('hoursIntervalGroup').style.display = freq === 'hours' ? 'block' : 'none';
        document.getElementById('dayOfWeekGroup').style.display = freq === 'weekly' ? 'block' : 'none';
        document.getElementById('dayOfMonthGroup').style.display = freq === 'monthly' ? 'block' : 'none';

        // Hide time selector for minute/hourly frequencies
        const timeGroup = document.getElementById('timeGroup');
        if (timeGroup) {
            timeGroup.style.display = (freq === 'minutes' || freq === 'hourly' || freq === 'hours') ? 'none' : 'block';
        }
        updateSchedulePreview();
    }

    // Build cron expression from UI fields
    function buildCronFromUI() {
        const freq = document.getElementById('scheduleFrequency').value;
        const minute = document.getElementById('scheduleMinute').value;
        let hour = parseInt(document.getElementById('scheduleHour').value);
        const ampm = document.getElementById('scheduleAmPm').value;

        // Convert to 24-hour
        if (ampm === 'PM' && hour !== 12) hour += 12;
        if (ampm === 'AM' && hour === 12) hour = 0;

        if (freq === 'minutes') {
            const interval = document.getElementById('scheduleMinutesInterval').value;
            // Every X minutes
            return `*/${interval} * * * *`;
        } else if (freq === 'hourly') {
            // Every hour at minute 0
            return `0 * * * *`;
        } else if (freq === 'hours') {
            const interval = document.getElementById('scheduleHoursInterval').value;
            // Every X hours starting at midnight
            return `0 */${interval} * * *`;
        } else if (freq === 'daily') {
            return `${minute} ${hour} * * *`;
        } else if (freq === 'weekly') {
            const dow = document.getElementById('scheduleDayOfWeek').value;
            return `${minute} ${hour} * * ${dow}`;
        } else if (freq === 'monthly') {
            const dom = document.getElementById('scheduleDayOfMonth').value;
            return `${minute} ${hour} ${dom} * *`;
        }
        return `${minute} ${hour} * * *`;
    }

    // Parse cron expression into UI fields
    function parseCronToUI(cron) {
        const parts = cron.split(' ');
        if (parts.length < 5) return;

        const [minute, hour24, dom, month, dow] = parts;

        // Check for every X minutes pattern (*/5, */10, etc.)
        if (minute.startsWith('*/') && hour24 === '*') {
            const interval = minute.substring(2);
            document.getElementById('scheduleFrequency').value = 'minutes';
            document.getElementById('scheduleMinutesInterval').value = interval;
            onFrequencyChange();
            return;
        }

        // Check for hourly patterns
        if (hour24 === '*' && !minute.startsWith('*/')) {
            document.getElementById('scheduleFrequency').value = 'hourly';
            onFrequencyChange();
            return;
        }

        // Check for every X hours pattern (*/2, */4, etc.)
        if (hour24.startsWith('*/')) {
            const interval = hour24.substring(2);
            document.getElementById('scheduleFrequency').value = 'hours';
            document.getElementById('scheduleHoursInterval').value = interval;
            onFrequencyChange();
            return;
        }

        // Set minute (find closest: 0, 15, 30, 45)
        const minVal = parseInt(minute) || 0;
        const closestMin = [0, 15, 30, 45].reduce((a, b) => Math.abs(b - minVal) < Math.abs(a - minVal) ? b : a);
        document.getElementById('scheduleMinute').value = closestMin;

        // Convert 24h to 12h AM/PM
        let hour = parseInt(hour24) || 0;
        let ampm = 'AM';
        if (hour >= 12) {
            ampm = 'PM';
            if (hour > 12) hour -= 12;
        }
        if (hour === 0) hour = 12;
        document.getElementById('scheduleHour').value = hour;
        document.getElementById('scheduleAmPm').value = ampm;

        // Determine frequency
        if (dow !== '*' && dom === '*') {
            document.getElementById('scheduleFrequency').value = 'weekly';
            document.getElementById('scheduleDayOfWeek').value = dow;
        } else if (dom !== '*' && dow === '*') {
            document.getElementById('scheduleFrequency').value = 'monthly';
            document.getElementById('scheduleDayOfMonth').value = dom;
        } else {
            document.getElementById('scheduleFrequency').value = 'daily';
        }

        onFrequencyChange();
    }

    // Update the schedule preview text
    function updateSchedulePreview() {
        const freq = document.getElementById('scheduleFrequency').value;
        const hour = document.getElementById('scheduleHour').value;
        const minute = document.getElementById('scheduleMinute').value;
        const ampm = document.getElementById('scheduleAmPm').value;
        const timeStr = `${hour}:${minute.toString().padStart(2, '0')} ${ampm}`;

        let preview = '';
        if (freq === 'minutes') {
            const interval = document.getElementById('scheduleMinutesInterval').value;
            preview = `Every ${interval} minutes`;
        } else if (freq === 'hourly') {
            preview = 'Every hour';
        } else if (freq === 'hours') {
            const interval = document.getElementById('scheduleHoursInterval').value;
            preview = `Every ${interval} hours`;
        } else if (freq === 'daily') {
            preview = `Daily at ${timeStr}`;
        } else if (freq === 'weekly') {
            const dow = document.getElementById('scheduleDayOfWeek').value;
            preview = `Every ${DAYS_OF_WEEK[dow]} at ${timeStr}`;
        } else if (freq === 'monthly') {
            const dom = document.getElementById('scheduleDayOfMonth').value;
            const suffix = dom == 1 ? 'st' : dom == 2 ? 'nd' : dom == 3 ? 'rd' : 'th';
            preview = `Monthly on the ${dom}${suffix} at ${timeStr}`;
        }
        document.getElementById('schedulePreview').textContent = preview;

        // Update hidden cron input
        document.getElementById('cronInput').value = buildCronFromUI();
    }

    function openEditModal(pipelineName, currentCron, enabled, priority) {
        document.getElementById('editPipelineName').textContent = pipelineName;
        document.getElementById('editPipelineId').value = pipelineName;
        document.getElementById('enabledCheck').checked = enabled;
        document.getElementById('priorityInput').value = priority || 5;

        // Parse cron into UI fields
        parseCronToUI(currentCron);

        document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    // Add change listeners for preview updates
    ['scheduleFrequency', 'scheduleDayOfWeek', 'scheduleDayOfMonth', 'scheduleHour', 'scheduleMinute', 'scheduleAmPm', 'scheduleMinutesInterval', 'scheduleHoursInterval'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateSchedulePreview);
    });

    // Handle form submit
    document.getElementById('editForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const pipelineName = document.getElementById('editPipelineId').value;
        const cron = buildCronFromUI();
        const enabled = document.getElementById('enabledCheck').checked;
        const priority = parseInt(document.getElementById('priorityInput').value) || 5;

        fetch('/api/jobs/' + pipelineName, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({cron: cron, enabled: enabled, priority: priority})
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Update local data immediately
                const job = jobsData.find(j => j.pipeline_name === pipelineName);
                if (job) {
                    job.schedule = data.schedule;
                    job.schedule_human = data.schedule_human;
                    job.enabled = data.enabled;
                    job.priority = data.priority;
                    renderJobs();
                }
                closeModal();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => alert('Error: ' + err));
    });

    let currentEventSource = null;
    let progressStartTime = null;
    let progressTimer = null;

    function runPipeline(name) {
        if (!confirm('Run ' + name + ' now?')) return;

        // Open progress modal
        document.getElementById('progressPipelineName').textContent = name;
        document.getElementById('progressStatus').textContent = 'Starting...';
        document.getElementById('progressStatus').className = 'status status-running';
        document.getElementById('progressOutput').innerHTML = '';
        document.getElementById('progressElapsed').textContent = '';
        document.getElementById('progressModal').style.display = 'flex';

        progressStartTime = Date.now();
        progressTimer = setInterval(updateElapsed, 1000);

        // Start async execution
        fetch('/api/jobs/' + name + '/run-async', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({mode: 'auto'})
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                appendOutput('[ERROR] ' + data.error);
                return;
            }

            // Start SSE stream
            const execId = data.execution_id;
            currentEventSource = new EventSource('/api/executions/' + execId + '/stream');

            currentEventSource.onmessage = function(e) {
                appendOutput(e.data);
            };

            currentEventSource.addEventListener('done', function(e) {
                const status = e.data;
                document.getElementById('progressStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);
                document.getElementById('progressStatus').className = 'status status-' + (status === 'completed' ? 'completed' : 'failed');
                clearInterval(progressTimer);
                currentEventSource.close();
                currentEventSource = null;
            });

            currentEventSource.onerror = function() {
                appendOutput('[Connection closed]');
                clearInterval(progressTimer);
                if (currentEventSource) {
                    currentEventSource.close();
                    currentEventSource = null;
                }
            };
        })
        .catch(err => {
            appendOutput('[ERROR] ' + err);
            clearInterval(progressTimer);
        });
    }

    function appendOutput(line) {
        const output = document.getElementById('progressOutput');
        const span = document.createElement('div');

        // Color code different line types
        if (line.startsWith('[ERROR]') || line.startsWith('[FAILED]')) {
            span.style.color = '#f66';
        } else if (line.startsWith('[DONE]')) {
            span.style.color = '#6f6';
        } else if (line.startsWith('[CMD]') || line.startsWith('[STDERR]')) {
            span.style.color = '#888';
        } else if (line.includes('Upsert') || line.includes('records')) {
            span.style.color = '#6cf';
        }

        span.textContent = line;
        output.appendChild(span);
        output.scrollTop = output.scrollHeight;
    }

    function updateElapsed() {
        if (progressStartTime) {
            const elapsed = Math.floor((Date.now() - progressStartTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('progressElapsed').textContent = mins > 0 ? mins + 'm ' + secs + 's' : secs + 's';
        }
    }

    function closeProgressModal() {
        document.getElementById('progressModal').style.display = 'none';
        if (currentEventSource) {
            currentEventSource.close();
            currentEventSource = null;
        }
        if (progressTimer) {
            clearInterval(progressTimer);
            progressTimer = null;
        }
        progressStartTime = null;
    }

    // Load jobs and data freshness
    Promise.all([
        fetch('/api/jobs').then(r => r.json()),
        fetch('/api/data-freshness').then(r => r.json())
    ])
    .then(([jobsResponse, freshnessResponse]) => {
        jobsData = jobsResponse.jobs || [];

        // Merge freshness data into jobs
        jobsData.forEach(job => {
            const freshness = freshnessResponse[job.pipeline_name];
            job.latest_data = freshness ? freshness.latest_date : null;
        });

        // Initial sort by priority
        sortJobs('priority');
    })
    .catch(err => {
        document.getElementById('jobs-table').innerHTML = '<tr><td colspan="7" style="text-align: center; color: #f66;">Error loading jobs</td></tr>';
    });

    // Close modal on background click
    document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
</script>
{% endblock %}
