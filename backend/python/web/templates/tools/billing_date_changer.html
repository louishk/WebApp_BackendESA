{% extends "base.html" %}

{% block title %}Billing Date Changer - ESA Backend{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Billing Date Changer</h1>
    <p style="color: #666; margin-top: 0.5rem;">Convert tenants to 1st-of-month billing</p>
</div>

<div class="card">
    <h2>Filters</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
        <div class="form-group" style="flex: 1; min-width: 250px;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Sites</label>
            <select id="site-select" class="form-select" multiple style="height: auto; min-height: 42px;">
            </select>
            <p style="color: #666; font-size: 0.8rem; margin-top: 0.25rem;">Hold Ctrl/Cmd to select multiple</p>
        </div>
        <div class="form-group">
            <button type="button" class="btn" onclick="loadSelectedSites()">Load Tenants</button>
        </div>
    </div>
</div>

<div id="tenants-section" style="display: none;">
    <div class="card">
        <h2>Site Summary</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="value" id="total-tenants">0</div>
                <div class="label">Active Tenants</div>
            </div>
            <div class="stat-card" style="background: #28A745;">
                <div class="value" id="on-first">0</div>
                <div class="label">On 1st Billing</div>
            </div>
            <div class="stat-card" style="background: #C41230;">
                <div class="value" id="not-on-first">0</div>
                <div class="label">Need Conversion</div>
            </div>
            <div class="stat-card">
                <div class="value" id="selected-count">0</div>
                <div class="label">Selected</div>
            </div>
            <div class="stat-card" id="processed-card" style="background: #17a2b8; display: none;">
                <div class="value" id="processed-count">0</div>
                <div class="label">Processed (Pending Sync)</div>
            </div>
        </div>
    </div>

    <div id="processed-notice" class="card" style="display: none; background: #d1ecf1; border-color: #bee5eb;">
        <p style="margin: 0; color: #0c5460;">
            <strong>Note:</strong> <span id="processed-notice-count">0</span> tenant(s) have been updated and are hidden from the list below.
            Changes will appear in the data after the next RentRoll sync.
        </p>
    </div>

    <div class="card">
        <h2>Tenants Requiring Conversion</h2>
        <div class="toolbar">
            <button type="button" class="btn btn-secondary btn-sm" onclick="selectAll()">Select All</button>
            <button type="button" class="btn btn-secondary btn-sm" onclick="selectNone()">Select None</button>
            <button type="button" class="btn btn-sm" id="change-btn" onclick="confirmChanges()" disabled>
                Change Selected to 1st
            </button>
        </div>
        <div id="tenants-table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="select-all-checkbox" onchange="toggleAll(this)"></th>
                        <th>Site</th>
                        <th>Unit</th>
                        <th>Tenant Name</th>
                        <th>Company</th>
                        <th>Current Day</th>
                        <th>Rent</th>
                        <th>Paid Through</th>
                    </tr>
                </thead>
                <tbody id="tenants-tbody">
                    <tr><td colspan="8" style="text-align: center; color: #666;">Select sites and click Load Tenants</td></tr>
                </tbody>
            </table>
        </div>
        <div id="no-conversion-message" style="display: none; text-align: center; padding: 2rem; color: #28A745;">
            All tenants at this site are already on 1st-of-month billing!
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div id="progress-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Processing Changes</h3>
        <div class="progress-info">
            <p>Processing: <span id="progress-current">0</span> / <span id="progress-total">0</span></p>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <p id="progress-status" style="margin-top: 1rem; color: #666;">Starting...</p>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div id="results-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Results</h3>
        <div class="results-summary">
            <div class="result-item success">
                <span class="result-value" id="result-success">0</span>
                <span class="result-label">Successful</span>
            </div>
            <div class="result-item failed">
                <span class="result-value" id="result-failed">0</span>
                <span class="result-label">Failed</span>
            </div>
        </div>
        <div id="results-details" style="max-height: 200px; overflow-y: auto; margin-top: 1rem;"></div>
        <div style="text-align: center; margin-top: 1.5rem;">
            <button type="button" class="btn" onclick="closeResults()">Close</button>
        </div>
    </div>
</div>

<style>
.form-group {
    margin-bottom: 1rem;
}
.form-select {
    width: 100%;
    max-width: 400px;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    border: 1px solid var(--esa-gray-dark);
    border-radius: 4px;
    background: #fff;
}
.form-select:focus {
    outline: none;
    border-color: var(--esa-navy);
}
.toolbar {
    margin-bottom: 1rem;
    display: flex;
    gap: 0.5rem;
}
.toolbar .btn {
    margin-right: 0.5rem;
}
#tenants-table-container {
    max-height: 500px;
    overflow-y: auto;
}
#tenants-table-container table {
    width: 100%;
}
#tenants-table-container thead {
    position: sticky;
    top: 0;
    background: var(--esa-gray);
    z-index: 10;
}
.tenant-row {
    cursor: pointer;
}
.tenant-row:hover {
    background: rgba(196, 18, 48, 0.1);
}
.tenant-row.selected {
    background: rgba(196, 18, 48, 0.15);
}
.billing-day {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
}
.billing-day.needs-conversion {
    background: #FFC107;
    color: #000;
}

/* Modal styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.modal-content {
    background: #fff;
    padding: 2rem;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}
.modal-content h3 {
    color: var(--esa-navy);
    margin-bottom: 1.5rem;
    text-align: center;
}
.progress-bar {
    height: 20px;
    background: var(--esa-gray-dark);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 1rem;
}
.progress-fill {
    height: 100%;
    background: var(--esa-red);
    transition: width 0.3s ease;
}
.results-summary {
    display: flex;
    justify-content: center;
    gap: 2rem;
}
.result-item {
    text-align: center;
    padding: 1rem 2rem;
    border-radius: 8px;
}
.result-item.success {
    background: rgba(40, 167, 69, 0.1);
    color: #28A745;
}
.result-item.failed {
    background: rgba(196, 18, 48, 0.1);
    color: #C41230;
}
.result-value {
    display: block;
    font-size: 2rem;
    font-weight: bold;
}
.result-label {
    font-size: 0.9rem;
}
.error-detail {
    padding: 0.5rem;
    margin: 0.25rem 0;
    background: rgba(196, 18, 48, 0.1);
    border-radius: 4px;
    font-size: 0.85rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // Disable auto-refresh for this tool page
    clearTimeout(window.autoRefreshTimeout);

    const API_TOKEN = localStorage.getItem('api_token') || '';
    let tenantsData = [];
    let selectedSites = []; // Array of {site_id, site_code}

    // Track successfully processed ledgers (hidden until RentRoll refresh)
    let processedLedgers = new Set();

    // Get CSRF token from meta tag
    function getCSRFToken() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute('content') : '';
    }

    function apiHeaders() {
        const headers = {
            'Content-Type': 'application/json'
        };
        if (API_TOKEN) {
            headers['Authorization'] = `Bearer ${API_TOKEN}`;
        }
        // Include CSRF token for POST requests
        const csrfToken = getCSRFToken();
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }
        return headers;
    }

    // Load sites dropdown
    async function loadSites() {
        try {
            const response = await fetch('/api/sites', {
                headers: apiHeaders()
            });
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            const data = await response.json();
            const select = document.getElementById('site-select');
            select.innerHTML = '';

            data.sites.forEach(site => {
                const option = document.createElement('option');
                option.value = site.site_id;
                option.dataset.code = site.site_code;
                option.textContent = `${site.site_code} - ${site.name}`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Failed to load sites:', error);
            alert('Failed to load sites. Please check your authentication.');
        }
    }

    // Load tenants for all selected sites
    async function loadSelectedSites() {
        const select = document.getElementById('site-select');
        const options = Array.from(select.selectedOptions);

        if (options.length === 0) {
            alert('Please select at least one site.');
            return;
        }

        selectedSites = options.map(o => ({ site_id: o.value, site_code: o.dataset.code }));
        processedLedgers = new Set();
        tenantsData = [];

        let totalTenants = 0;
        let totalOnFirst = 0;
        let totalNotOnFirst = 0;

        for (const site of selectedSites) {
            try {
                const response = await fetch(`/api/billing-day/${site.site_id}`, {
                    headers: apiHeaders()
                });
                if (!response.ok) continue;
                const data = await response.json();

                const ledgers = (data.ledgers || []).map(l => ({ ...l, _site_code: data.site_code }));
                tenantsData = tenantsData.concat(ledgers);
                totalTenants += data.total_tenants;
                totalOnFirst += data.on_first;
                totalNotOnFirst += data.not_on_first;
            } catch (e) {
                console.error(`Failed to load site ${site.site_code}:`, e);
            }
        }

        document.getElementById('total-tenants').textContent = totalTenants;
        document.getElementById('on-first').textContent = totalOnFirst;
        document.getElementById('not-on-first').textContent = totalNotOnFirst;
        updateProcessedDisplay();
        document.getElementById('tenants-section').style.display = 'block';
        renderTenants();
        updateSelectedCount();
    }

    // Update processed count display
    function updateProcessedDisplay() {
        const count = processedLedgers.size;
        const processedCard = document.getElementById('processed-card');
        const processedNotice = document.getElementById('processed-notice');

        if (count > 0) {
            document.getElementById('processed-count').textContent = count;
            document.getElementById('processed-notice-count').textContent = count;
            processedCard.style.display = 'block';
            processedNotice.style.display = 'block';
        } else {
            processedCard.style.display = 'none';
            processedNotice.style.display = 'none';
        }
    }

    // Render tenants table
    function renderTenants() {
        const tbody = document.getElementById('tenants-tbody');
        const tableContainer = document.getElementById('tenants-table-container');
        const noConversionMsg = document.getElementById('no-conversion-message');

        // Filter to only show tenants needing conversion AND not already processed
        const needsConversion = tenantsData.filter(t =>
            t.NeedsConversion && !processedLedgers.has(t.LedgerID)
        );

        if (needsConversion.length === 0) {
            tableContainer.style.display = 'none';
            if (processedLedgers.size > 0) {
                noConversionMsg.innerHTML = `All remaining tenants at this site are on 1st-of-month billing!<br><small style="color: #666;">${processedLedgers.size} tenant(s) processed this session - pending RentRoll sync</small>`;
            } else {
                noConversionMsg.innerHTML = 'All tenants at this site are already on 1st-of-month billing!';
            }
            noConversionMsg.style.display = 'block';
            document.querySelector('.toolbar').style.display = 'none';
            return;
        }

        tableContainer.style.display = 'block';
        noConversionMsg.style.display = 'none';
        document.querySelector('.toolbar').style.display = 'flex';

        tbody.innerHTML = needsConversion.map(tenant => `
            <tr class="tenant-row" data-ledger-id="${tenant.LedgerID}" data-site-code="${tenant._site_code}" onclick="toggleRow(this)">
                <td><input type="checkbox" class="tenant-checkbox" onclick="event.stopPropagation(); updateSelectedCount();"></td>
                <td>${tenant._site_code || '-'}</td>
                <td><strong>${tenant.UnitName || '-'}</strong></td>
                <td>${tenant.TenantName || '-'}</td>
                <td>${tenant.Company || '-'}</td>
                <td><span class="billing-day needs-conversion">${tenant.BillingDay}</span></td>
                <td>${tenant.Rent ? '$' + tenant.Rent.toFixed(2) : '-'}</td>
                <td>${tenant.PaidThruDate ? formatDate(tenant.PaidThruDate) : '-'}</td>
            </tr>
        `).join('');
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-SG', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    // Toggle row selection
    function toggleRow(row) {
        const checkbox = row.querySelector('.tenant-checkbox');
        checkbox.checked = !checkbox.checked;
        row.classList.toggle('selected', checkbox.checked);
        updateSelectedCount();
    }

    // Toggle all checkboxes
    function toggleAll(masterCheckbox) {
        const checkboxes = document.querySelectorAll('.tenant-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = masterCheckbox.checked;
            cb.closest('tr').classList.toggle('selected', cb.checked);
        });
        updateSelectedCount();
    }

    // Select all
    function selectAll() {
        document.getElementById('select-all-checkbox').checked = true;
        toggleAll(document.getElementById('select-all-checkbox'));
    }

    // Select none
    function selectNone() {
        document.getElementById('select-all-checkbox').checked = false;
        toggleAll(document.getElementById('select-all-checkbox'));
    }

    // Update selected count
    function updateSelectedCount() {
        const checked = document.querySelectorAll('.tenant-checkbox:checked').length;
        document.getElementById('selected-count').textContent = checked;
        document.getElementById('change-btn').disabled = checked === 0;
    }

    // Confirm changes
    function confirmChanges() {
        const selected = document.querySelectorAll('.tenant-checkbox:checked');
        if (selected.length === 0) {
            alert('Please select at least one tenant.');
            return;
        }

        const count = selected.length;
        const plural = count === 1 ? '' : 's';

        if (confirm(`Are you sure you want to change ${count} tenant${plural} to 1st-of-month billing?\n\nThis will update the billing schedule and may generate pro-rated charges.`)) {
            executeChanges();
        }
    }

    // Execute billing day changes
    async function executeChanges() {
        const selected = document.querySelectorAll('.tenant-checkbox:checked');
        const entries = Array.from(selected).map(cb => {
            const row = cb.closest('tr');
            return { ledgerId: parseInt(row.dataset.ledgerId), siteCode: row.dataset.siteCode };
        });

        // Show progress modal
        const progressModal = document.getElementById('progress-modal');
        const progressCurrent = document.getElementById('progress-current');
        const progressTotal = document.getElementById('progress-total');
        const progressFill = document.getElementById('progress-fill');
        const progressStatus = document.getElementById('progress-status');

        progressModal.style.display = 'flex';
        progressTotal.textContent = entries.length;
        progressCurrent.textContent = '0';
        progressFill.style.width = '0%';

        let successCount = 0;
        let failedCount = 0;
        const errors = [];

        for (let i = 0; i < entries.length; i++) {
            const { ledgerId, siteCode } = entries[i];
            const tenant = tenantsData.find(t => t.LedgerID === ledgerId);

            progressCurrent.textContent = i + 1;
            progressFill.style.width = ((i + 1) / entries.length * 100) + '%';
            progressStatus.textContent = `Processing: ${tenant ? tenant.UnitName : ledgerId}...`;

            try {
                const response = await fetch('/api/billing-day/update', {
                    method: 'POST',
                    headers: apiHeaders(),
                    body: JSON.stringify({
                        site_code: siteCode,
                        ledger_id: ledgerId,
                        billing_day: 1,
                        commit: true
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    successCount++;
                    // Track this ledger as processed (hide from list)
                    processedLedgers.add(ledgerId);
                } else {
                    failedCount++;
                    errors.push({
                        unit: tenant ? tenant.UnitName : ledgerId,
                        error: result.error || result.details || 'Unknown error'
                    });
                }
            } catch (error) {
                failedCount++;
                errors.push({
                    unit: tenant ? tenant.UnitName : ledgerId,
                    error: error.message
                });
            }

            // Small delay between requests to avoid overwhelming the API
            await new Promise(resolve => setTimeout(resolve, 200));
        }

        // Hide progress modal
        progressModal.style.display = 'none';

        // Show results modal
        showResults(successCount, failedCount, errors);
    }

    // Show results modal
    function showResults(success, failed, errors) {
        const modal = document.getElementById('results-modal');
        document.getElementById('result-success').textContent = success;
        document.getElementById('result-failed').textContent = failed;

        const detailsDiv = document.getElementById('results-details');
        if (errors.length > 0) {
            detailsDiv.innerHTML = '<p style="font-weight: 600; margin-bottom: 0.5rem;">Errors:</p>' +
                errors.map(e => `<div class="error-detail"><strong>${e.unit}:</strong> ${e.error}</div>`).join('');
        } else {
            detailsDiv.innerHTML = '';
        }

        modal.style.display = 'flex';
    }

    // Close results and refresh display (without reloading from server)
    function closeResults() {
        document.getElementById('results-modal').style.display = 'none';

        // Update counts to reflect processed items
        const originalNotOnFirst = tenantsData.filter(t => t.NeedsConversion).length;
        const remainingNotOnFirst = originalNotOnFirst - processedLedgers.size;

        document.getElementById('on-first').textContent =
            parseInt(document.getElementById('total-tenants').textContent) - remainingNotOnFirst;
        document.getElementById('not-on-first').textContent = Math.max(0, remainingNotOnFirst);

        // Update processed display
        updateProcessedDisplay();

        // Re-render the table (will exclude processed items)
        renderTenants();
        updateSelectedCount();

        // Uncheck master checkbox
        document.getElementById('select-all-checkbox').checked = false;
    }

    // Initialize
    loadSites();
</script>
{% endblock %}
